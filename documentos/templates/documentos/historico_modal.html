{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Histórico do Documento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="{% static 'css/custom.css' %}" rel="stylesheet">
    <link href="{% static 'css/main.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        /* Wrapper mais estreito e centralizado, responsivo */
        .modal-wrapper { max-width: 700px; width: 100%; margin: 0 auto; }
        @media (max-width: 576px) { .modal-wrapper { padding: 8px !important; } }

        /* Cards responsivos: Fornecedor+Descrição e Valor lado a lado em telas médias */
        .info-cards { display: grid; grid-template-columns: 1fr; gap: 5px; }
        @media (min-width: 768px) { .info-cards { grid-template-columns: 2fr 1fr; } }
        .card .card-body { padding: 0.45rem; }
        .fornecedor-display { font-size: 0.95rem; }
        .descricao-display { font-size: 0.95rem; }
        .valor-display { font-size: 1.05rem; }
        .break-text { overflow-wrap: anywhere; word-break: break-word; }

        /* Linha do tempo responsiva */
        .timeline { position: relative; margin-top: 24px; }
        .timeline::before { content: ''; position: absolute; left: 18px; top: 0; bottom: 0; width: 2px; background: #e0e0e0; }
        .timeline-item { position: relative; padding-left: 44px; padding-bottom: 16px; }
        .timeline-item::before { content: ''; position: absolute; left: 12px; top: 4px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; }
        /* Paleta refinada */
        .timeline-item.completed::before { background: #2e7d32; box-shadow: 0 0 0 2px #2e7d3222; } /* verde 600 */
        .timeline-item.pending::before { background: #b0b8c2; box-shadow: 0 0 0 2px #b0b8c222; } /* cinza frio */
        .badge-stage { margin-right: 8px; }
        .badge-stage i { margin-right: 4px; }

        /* Layout flutuante como antes, com rolagem interna no card */
        .modal-embed-body { max-height: calc(100vh - 160px); overflow-y: auto; }
    </style>
</head>
<body>
    <!-- Conteúdo direto (sem card externo e sem backdrop), para parecer a tela flutuante única) -->
    <div class="modal-wrapper p-3">
        <!-- Barra de cabeçalho única com texto -->
        <div class="d-flex align-items-center border-bottom mb-2 pb-2">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Histórico de Alterações</h5>
        </div>
        <!-- Linha com número do documento e secretaria na mesma linha -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Documento: {{ documento.numero }}</h6>
            {% if documento.secretaria %}
                <span class="badge bg-info text-dark">{{ documento.secretaria.nome }}</span>
            {% endif %}
        </div>

        <div class="info-cards mb-3">
            <!-- Card Fornecedor + Descrição -->
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small mb-1"><i class="bi bi-person me-1"></i>Fornecedor</div>
                    <div class="fornecedor-display fw-semibold break-text">{{ documento.fornecedor }}</div>
                    <div class="text-muted small mt-3"><i class="bi bi-file-earmark-text me-1"></i>Descrição</div>
                    <div class="descricao-display break-text">{{ documento.descricao|default:"-" }}</div>
                </div>
            </div>
            <!-- Card Valor -->
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small mb-1"><i class="bi bi-cash-stack me-1"></i>Valor</div>
                    <div class="valor-display fw-semibold">R$ {{ documento.valor_documento|currency_br }}</div>
                </div>
            </div>
        </div>

        <h6 class="mb-2"><i class="bi bi-clock-history me-2"></i>Linha do Tempo</h6>
        <div class="timeline">
            {% for item in etapas_info %}
                <div class="timeline-item {% if item.concluida %}completed{% else %}pending{% endif %}">
                    <div class="d-flex justify-content-between flex-wrap gap-2">
                        <div class="flex-grow-1">
                            {% if item.key == 'ABERTURA' %}
                                <span class="badge bg-secondary badge-stage"><i class="bi bi-journal-plus"></i>Abertura de Processo</span>
                            {% elif item.key == 'CONTROLE_INTERNO' %}
                                <span class="badge bg-info text-dark badge-stage"><i class="bi bi-shield-check"></i>Controle Interno</span>
                            {% elif item.key == 'EMPENHO' %}
                                <span class="badge bg-warning text-dark badge-stage"><i class="bi bi-clipboard-check"></i>Empenho</span>
                            {% elif item.key == 'PAGAMENTO' %}
                                <span class="badge bg-primary badge-stage"><i class="bi bi-credit-card"></i>Pagamento</span>
                            {% elif item.key == 'BAIXA' %}
                                <span class="badge bg-success badge-stage"><i class="bi bi-check-circle"></i>Baixa</span>
                            {% endif %}
                            {% if item.descricao %}
                                <div class="text-muted small mt-1 break-text">{{ item.descricao }}</div>
                            {% endif %}
                        </div>
                        <div class="text-end text-muted small flex-shrink-0">
                            {% if item.data %}{{ item.data|date:"d/m/Y H:i:s" }}{% else %}-{% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <h6 class="mt-3 mb-2"><i class="bi bi-list-check me-2"></i>Alterações</h6>
        <div class="list-group">
            {% for h in historicos %}
                <div class="list-group-item d-flex justify-content-between align-items-center py-1 px-3">
                    <div>
                        {% if h.etapa == 'ABERTURA' %}
                            <span class="badge bg-secondary me-2"><i class="bi bi-journal-plus"></i>Abertura de Processo</span>
                        {% elif h.etapa == 'CONTROLE_INTERNO' %}
                            <span class="badge bg-info text-dark me-2"><i class="bi bi-shield-check"></i>Controle Interno</span>
                        {% elif h.etapa == 'EMPENHO' %}
                            <span class="badge bg-warning text-dark me-2"><i class="bi bi-clipboard-check"></i>Empenho</span>
                        {% elif h.etapa == 'PAGAMENTO' %}
                            <span class="badge bg-primary me-2"><i class="bi bi-credit-card"></i>Pagamento</span>
                        {% elif h.etapa == 'BAIXA' %}
                            <span class="badge bg-success me-2"><i class="bi bi-check-circle"></i>Baixa</span>
                        {% endif %}
                        <div class="text-muted small">{{ h.descricao|default:"" }}</div>
                    </div>
                    <div class="text-end">
                        <div>{{ h.data_hora|date:"d/m/Y H:i:s" }}</div>
                        <div class="text-muted small">{% if h.usuario %}{{ h.usuario.get_full_name|default:h.usuario.username }}{% else %}Sistema{% endif %}</div>
                    </div>
                </div>
            {% empty %}
                <div class="alert alert-info">Nenhuma alteração registrada ainda.</div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
