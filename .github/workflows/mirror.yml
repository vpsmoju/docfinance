name: Mirror to vpsmoju/docfinance_copia

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Evita que o checkout grave o GITHUB_TOKEN em credenciais,
          # garantindo que o push use o MIRROR_PAT fornecido abaixo.
          persist-credentials: false

      - name: Clear residual credentials
        shell: bash
        run: |
          set -euo pipefail
          # Remove headers/credenciais que poderiam forÃ§ar uso do GITHUB_TOKEN
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --global --unset-all credential.helper || true
          git config --global --unset-all url.https://github.com/.insteadof || true
          echo "Credential helpers e extraheaders limpos."

      - name: Verify MIRROR_PAT access to mirror repo
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.MIRROR_PAT }}" ]; then
            echo "Secret MIRROR_PAT not defined. Add it in Settings > Secrets and variables > Actions." >&2
            exit 1
          fi
          echo "Checking API access to vpsmoju/docfinance_copia with MIRROR_PAT..."
          STATUS=$(curl -sS -H "Authorization: token ${{ secrets.MIRROR_PAT }}" -o /dev/null -w "%{http_code}" https://api.github.com/repos/vpsmoju/docfinance_copia)
          if [ "$STATUS" != "200" ]; then
            echo "Access check failed (HTTP $STATUS). Ensure PAT has repo (write) and workflow scopes or fine-grained Actions+Contents write." >&2
            exit 1
          fi
          echo "API access OK (200). Proceeding to push."

      - name: Push to mirror repository with lease
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "DocFinance Mirror Bot"
          git config --global user.email "actions@users.noreply.github.com"
          git remote remove mirror || true
          git remote add mirror https://vpsmoju:${{ secrets.MIRROR_PAT }}@github.com/vpsmoju/docfinance_copia.git
          git fetch mirror main || true
          git push --force-with-lease mirror main:main
          git push mirror --tags
