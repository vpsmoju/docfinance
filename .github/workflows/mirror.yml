name: Mirror to kinhomoju/docfinance_copia

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Evita que o checkout grave o GITHUB_TOKEN em credenciais,
          # garantindo que o push use o MIRROR_PAT fornecido abaixo.
          persist-credentials: false

      - name: Verify MIRROR_PAT access to mirror repo
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.MIRROR_PAT }}" ]; then
            echo "Secret MIRROR_PAT not defined. Add it in Settings > Secrets and variables > Actions." >&2
            exit 1
          fi
          echo "Checking API access to kinhomoju/docfinance_copia with MIRROR_PAT..."
          STATUS=$(curl -sS -H "Authorization: token ${{ secrets.MIRROR_PAT }}" -o /dev/null -w "%{http_code}" https://api.github.com/repos/kinhomoju/docfinance_copia)
          if [ "$STATUS" != "200" ]; then
            echo "Access check failed (HTTP $STATUS). Ensure PAT has repo (write) and workflow scopes or fine-grained Actions+Contents write." >&2
            exit 1
          fi
          echo "API access OK (200). Proceeding to push."

      - name: Push to mirror repository
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.MIRROR_PAT }}
          repository: kinhomoju/docfinance_copia
          branch: main
          tags: true
          force: false
